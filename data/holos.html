<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Holos â€” AstroPixels</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/icons8-r2-d2-color-32.png?v=2">
  <link rel="shortcut icon" type="image/png" href="/icons8-r2-d2-color-32.png?v=2">
  <link rel="apple-touch-icon" sizes="192x192" href="/icons8-r2-d2-color-192.png">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <h1>Holo Projectors ðŸ’¡</h1>
  <div class="subtitle">HP1 (FHP), HP2 (RHP), HP3 (THP) LED + servo holoprojectors</div>
  <nav>
    <a href="/">Home</a>
    <a href="/setup.html">Setup</a>
    <a href="/panels.html">Panels</a>
    <a href="/holos.html" class="active">Holos</a>
    <a href="/logics.html">Logics</a>
    <a href="/sequences.html">Sequences</a>
  </nav>

  <div class="card" id="holo-health-card" style="display:none;">
    <h3>Holo Servo Controller Status</h3>
    <div class="desc" id="holo-health-text">Checking controller availability...</div>
    <div class="i2c-list" id="holo-i2c-list"></div>
    <div class="i2c-list" id="holo-i2c-codes"></div>
    <div class="i2c-list" id="holo-i2c-hint"></div>
    <div class="mt-8"><button id="holo-deep-btn" class="btn" onclick="window.runHoloDeepDiag()">Run Deep I2C Scan</button></div>
    <div id="holo-deep-result" class="i2c-list">Deep scan result: not run yet. Full-bus scan checks addresses 0x01-0x7E.</div>
    <div class="i2c-list" id="holo-last-cmd"></div>
  </div>

  <!-- All Holos -->
  <div class="card">
    <h3>All Holoprojectors (HP1/HP2/HP3)</h3>
    <div class="btn-grid">
      <button class="btn accent" onclick="sendCmd('*ON00')">All On</button>
      <button class="btn danger" onclick="sendCmd('*OF00')">All Off</button>
      <button class="btn" onclick="sendCmd('*ST00')">Reset All</button>
    </div>
    <div class="mt-6">
      <span class="label-dim">Showcase Modes:</span>
      <div class="btn-grid mt-4">
        <button class="btn" title="Wag all three holo servos left/right together" onclick="sendCmd('*HW00')">All Wag</button>
        <button class="btn" title="Nod all three holo servos up/down together" onclick="sendCmd('*HN00')">All Nod</button>
        <button class="btn" title="Enable default ReelTwo holo twitch patterns" onclick="sendCmd('*HD08')">Default Twitch</button>
        <button class="btn" title="Enable randomized ReelTwo holo twitch patterns" onclick="sendCmd('*HD09')">Random Twitch</button>
        <button class="btn danger" title="Disable holo twitch and force idle state" onclick="sendCmd('*HD07')">Disable Twitch</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>HP1 - Holoprojector 1 Front (FHP)</h3>
    <div class="btn-grid">
      <button class="btn accent" onclick="sendCmd('*ON01')">On</button>
      <button class="btn danger" onclick="sendCmd('*OF01')">Off</button>
      <button class="btn" onclick="sendCmd('*RD01')">Random Move</button>
      <button class="btn" onclick="sendCmd('*HW01')">Wag</button>
      <button class="btn" onclick="sendCmd('*HN01')">Nod</button>
    </div>
    <div class="mt-6">
      <span class="label-dim">LED Effects:</span>
      <div class="btn-grid mt-4">
        <button class="btn" onclick="sendCmd('*HPF005')">Static</button>
        <button class="btn" onclick="sendCmd('*HPF0040')">Cycle</button>
        <button class="btn" onclick="sendCmd('*HPS301')">Pulse</button>
        <button class="btn" onclick="sendCmd('*HPS601')">Rainbow</button>
      </div>
    </div>
    <div class="mt-6">
      <span class="label-dim">Position:</span>
      <div class="dir-pad mt-4">
        <button class="btn" aria-label="HP1 upper left" onclick="sendCmd('*HP401')">&#x2196;</button>
        <button class="btn" aria-label="HP1 up" onclick="sendCmd('*HP201')">&#x2191;</button>
        <button class="btn" aria-label="HP1 upper right" onclick="sendCmd('*HP701')">&#x2197;</button>
        <button class="btn" aria-label="HP1 left" onclick="sendCmd('*HP301')">&#x2190;</button>
        <button class="btn accent" aria-label="HP1 center" onclick="sendCmd('*HP101')">&#x25CF;</button>
        <button class="btn" aria-label="HP1 right" onclick="sendCmd('*HP601')">&#x2192;</button>
        <button class="btn" aria-label="HP1 lower left" onclick="sendCmd('*HP501')">&#x2199;</button>
        <button class="btn" aria-label="HP1 down" onclick="sendCmd('*HP001')">&#x2193;</button>
        <button class="btn" aria-label="HP1 lower right" onclick="sendCmd('*HP801')">&#x2198;</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>HP2 - Holoprojector 2 Rear (RHP)</h3>
    <div class="btn-grid">
      <button class="btn accent" onclick="sendCmd('*ON02')">On</button>
      <button class="btn danger" onclick="sendCmd('*OF02')">Off</button>
      <button class="btn" onclick="sendCmd('*RD02')">Random Move</button>
      <button class="btn" onclick="sendCmd('*HW02')">Wag</button>
      <button class="btn" onclick="sendCmd('*HN02')">Nod</button>
    </div>
    <div class="mt-6">
      <span class="label-dim">LED Effects:</span>
      <div class="btn-grid mt-4">
        <button class="btn" onclick="sendCmd('*HPR005')">Static</button>
        <button class="btn" onclick="sendCmd('*HPR0040')">Cycle</button>
        <button class="btn" onclick="sendCmd('*HPS302')">Pulse</button>
        <button class="btn" onclick="sendCmd('*HPS602')">Rainbow</button>
      </div>
    </div>
    <div class="mt-6">
      <span class="label-dim">Position:</span>
      <div class="dir-pad mt-4">
        <button class="btn" aria-label="HP2 upper left" onclick="sendCmd('*HP402')">&#x2196;</button>
        <button class="btn" aria-label="HP2 up" onclick="sendCmd('*HP202')">&#x2191;</button>
        <button class="btn" aria-label="HP2 upper right" onclick="sendCmd('*HP702')">&#x2197;</button>
        <button class="btn" aria-label="HP2 left" onclick="sendCmd('*HP302')">&#x2190;</button>
        <button class="btn accent" aria-label="HP2 center" onclick="sendCmd('*HP102')">&#x25CF;</button>
        <button class="btn" aria-label="HP2 right" onclick="sendCmd('*HP602')">&#x2192;</button>
        <button class="btn" aria-label="HP2 lower left" onclick="sendCmd('*HP502')">&#x2199;</button>
        <button class="btn" aria-label="HP2 down" onclick="sendCmd('*HP002')">&#x2193;</button>
        <button class="btn" aria-label="HP2 lower right" onclick="sendCmd('*HP802')">&#x2198;</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>HP3 - Holoprojector 3 Top (THP)</h3>
    <div class="btn-grid">
      <button class="btn accent" onclick="sendCmd('*ON03')">On</button>
      <button class="btn danger" onclick="sendCmd('*OF03')">Off</button>
      <button class="btn" onclick="sendCmd('*RD03')">Random Move</button>
      <button class="btn" onclick="sendCmd('*HW03')">Wag</button>
      <button class="btn" onclick="sendCmd('*HN03')">Nod</button>
    </div>
    <div class="mt-6">
      <span class="label-dim">LED Effects:</span>
      <div class="btn-grid mt-4">
        <button class="btn" onclick="sendCmd('*HPT005')">Static</button>
        <button class="btn" onclick="sendCmd('*HPT0040')">Cycle</button>
        <button class="btn" onclick="sendCmd('*HPS303')">Pulse</button>
        <button class="btn" onclick="sendCmd('*HPS603')">Rainbow</button>
      </div>
    </div>
    <div class="mt-6">
      <span class="label-dim">Position:</span>
      <div class="dir-pad mt-4">
        <button class="btn" aria-label="HP3 upper left" onclick="sendCmd('*HP403')">&#x2196;</button>
        <button class="btn" aria-label="HP3 up" onclick="sendCmd('*HP203')">&#x2191;</button>
        <button class="btn" aria-label="HP3 upper right" onclick="sendCmd('*HP703')">&#x2197;</button>
        <button class="btn" aria-label="HP3 left" onclick="sendCmd('*HP303')">&#x2190;</button>
        <button class="btn accent" aria-label="HP3 center" onclick="sendCmd('*HP103')">&#x25CF;</button>
        <button class="btn" aria-label="HP3 right" onclick="sendCmd('*HP603')">&#x2192;</button>
        <button class="btn" aria-label="HP3 lower left" onclick="sendCmd('*HP503')">&#x2199;</button>
        <button class="btn" aria-label="HP3 down" onclick="sendCmd('*HP003')">&#x2193;</button>
        <button class="btn" aria-label="HP3 lower right" onclick="sendCmd('*HP803')">&#x2198;</button>
      </div>
    </div>
  </div>

  <!-- Radar Eye -->
  <div class="card">
    <h3>Radar Eye</h3>
    <div class="desc">Standalone LED effects for the radar eye (no servo movement)</div>
    <div class="btn-grid">
      <button class="btn" onclick="sendCmd('*HRS3')">Pulse</button>
      <button class="btn" onclick="sendCmd('*HRSR')">Pulse Red</button>
      <button class="btn" onclick="sendCmd('*HRS6')">Rainbow</button>
      <button class="btn" onclick="sendCmd('*HRS4')">Cycle</button>
      <button class="btn danger" onclick="sendCmd('*OF04')">Off</button>
    </div>
  </div>

  <div class="card">
    <h3>Expanded Holo Commands</h3>
    <div class="desc">Compatibility controls for expanded holo commands.</div>
    <div class="mt-6">
      <span class="label-dim">Center Commands:</span>
      <div class="btn-grid mt-4">
        <button class="btn" onclick="sendCmd('*CH00')">Center All</button>
        <button class="btn" onclick="sendCmd('*CH01')">Center HP1</button>
        <button class="btn" onclick="sendCmd('*CH02')">Center HP2</button>
        <button class="btn" onclick="sendCmd('*CH03')">Center HP3</button>
      </div>
    </div>
    <div class="mt-6">
      <span class="label-dim">Mechanical Test:</span>
      <div class="btn-grid mt-4">
        <button class="btn" onclick="sendCmd('*TE00')">Test All</button>
        <button class="btn" onclick="sendCmd('*TE01')">Test HP1</button>
        <button class="btn" onclick="sendCmd('*TE02')">Test HP2</button>
        <button class="btn" onclick="sendCmd('*TE03')">Test HP3</button>
      </div>
    </div>
    <div class="mt-6">
      <span class="label-dim">RC-Center Alias:</span>
      <div class="btn-grid mt-4">
        <button class="btn" onclick="sendCmd('*RC00')">RC All</button>
        <button class="btn" onclick="sendCmd('*RC01')">RC HP1</button>
        <button class="btn" onclick="sendCmd('*RC02')">RC HP2</button>
        <button class="btn" onclick="sendCmd('*RC03')">RC HP3</button>
      </div>
    </div>
  </div>

  <div class="status-bar" id="conn-status"><span class="dot yellow"></span>Connecting...</div>
  <script src="/app.js"></script>
  <script>
    (function() {
      'use strict';

      var healthTextEl = document.getElementById('holo-health-text');
      var i2cListEl = document.getElementById('holo-i2c-list');
      var i2cCodesEl = document.getElementById('holo-i2c-codes');
      var i2cHintEl = document.getElementById('holo-i2c-hint');
      var deepResultEl = document.getElementById('holo-deep-result');
      var deepBtnEl = document.getElementById('holo-deep-btn');
      var lastCmdEl = document.getElementById('holo-last-cmd');
      var healthCardEl = document.getElementById('holo-health-card');

      function setHealthText(html) {
        if (healthTextEl) healthTextEl.innerHTML = html;
      }

      function updateHoloHealth(h) {
        if (!h || typeof h.i2c_holos === 'undefined') return;

        if (h.i2c_holos) {
          if (healthCardEl) healthCardEl.style.borderLeftColor = 'var(--success)';
          if (healthCardEl) healthCardEl.style.display = 'none';
          setHealthText('<span class="dot green"></span>Holo servo controller detected at I2C 0x41. Holo movement commands should reach hardware. Holo LED light control remains on the AstroPixels board.');
        } else {
          if (healthCardEl) healthCardEl.style.borderLeftColor = 'var(--warning)';
          if (healthCardEl) healthCardEl.style.display = '';
          setHealthText('<span class="dot yellow"></span>No holo servo controller detected at I2C 0x41. Check holo controller power/wiring.');
        }

        if (i2cListEl) {
          if (h.i2c_devices && h.i2c_devices.length > 0) {
            i2cListEl.textContent = 'Detected I2C devices: ' + h.i2c_devices.join(', ');
          } else {
            i2cListEl.textContent = 'Detected I2C devices: none';
          }
        }
      }

      function updateHoloDiag(d) {
        if (!d || !d.holos) return;
        if (i2cCodesEl) {
          i2cCodesEl.textContent =
            'I2C code/streak for holo controller (0x41): code ' + d.holos.last_code +
            ', failures ' + d.holos.consecutive_failures +
            ' | scan age ' + d.scan_age_ms + ' ms';
        }

        if (i2cHintEl) {
          var hint = '';
          if (d.operator && d.operator.hints && d.operator.hints.length > 0) {
            hint = d.operator.hints[0];
          }
          i2cHintEl.textContent = hint
            ? ('Troubleshooting hint: ' + hint)
            : 'Troubleshooting hint: I2C checks are currently stable.';
        }
      }

      function refreshHoloDiag(force) {
        var url = force ? '/api/diag/i2c?force=1' : '/api/diag/i2c';
        if (force) setDeepStateRunning();
        return fetch(url).then(function(r) { return r.json(); }).then(function(d) {
          updateHoloDiag(d);
          if (force) {
            updateDeepResult(d);
            if (typeof window.uiToast === 'function') window.uiToast('Deep I2C scan completed', d.holos && d.holos.ok ? '' : 'warn');
          }
          return d;
        }).catch(function() {
          if (i2cCodesEl) i2cCodesEl.textContent = 'I2C code: unable to read /api/diag/i2c';
          if (i2cHintEl) i2cHintEl.textContent = 'Troubleshooting hint: diagnostics endpoint unavailable right now.';
          if (force && deepResultEl) deepResultEl.textContent = 'Deep scan result: failed (cannot reach /api/diag/i2c).';
          if (force && typeof window.uiToast === 'function') window.uiToast('Deep I2C scan failed', 'error');
        }).finally(function() {
          if (force) setDeepStateIdle();
        });
      }

      function setDeepStateRunning() {
        if (deepBtnEl) {
          deepBtnEl.disabled = true;
          deepBtnEl.textContent = 'Running Deep I2C Scan...';
        }
        if (deepResultEl) {
          deepResultEl.textContent = 'Deep scan result: running full-bus scan (0x01-0x7E)...';
        }
      }

      function setDeepStateIdle() {
        if (deepBtnEl) {
          deepBtnEl.disabled = false;
          deepBtnEl.textContent = 'Run Deep I2C Scan';
        }
      }

      function updateDeepResult(d) {
        if (!deepResultEl || !d) return;
        var faults = (d.operator && d.operator.faults && d.operator.faults.length) ? d.operator.faults.join(', ') : 'none';
        var devices = (d.devices && d.devices.length) ? d.devices.join(', ') : 'none';
        var status = (d.holos && d.holos.ok) ? 'holo controller detected' : 'holo controller missing';
        var ts = new Date().toLocaleTimeString();
        deepResultEl.textContent =
          '[' + ts + '] Deep scan done (full bus 0x01-0x7E): ' + status +
          '; devices=' + d.device_count +
          ' [' + devices + ']' +
          '; duration=' + d.scan_duration_us + ' us' +
          '; faults=' + faults +
          '; scan_mode=' + d.scan_mode + '.';
      }

      window.runHoloDeepDiag = function() {
        refreshHoloDiag(true);
      };

      function setLastCmdStatus(cmd, statusText) {
        if (!lastCmdEl) return;
        var ts = new Date().toLocaleTimeString();
        lastCmdEl.textContent = '[' + ts + '] ' + cmd + ' -> ' + statusText;
      }

      window.sendCmd = function(cmd) {
        setLastCmdStatus(cmd, 'sending via /api/cmd');
        if (typeof window.apiPostForm !== 'function') {
          setLastCmdStatus(cmd, 'failed: apiPostForm unavailable');
          return;
        }

        window.apiPostForm('/api/cmd', 'cmd=' + encodeURIComponent(cmd))
          .then(function(resp) {
            if (resp.ok) {
              setLastCmdStatus(cmd, 'accepted (HTTP ' + resp.status + ')');
            } else {
              setLastCmdStatus(cmd, 'rejected (HTTP ' + resp.status + ')');
            }
          })
          .catch(function() {
            setLastCmdStatus(cmd, 'failed: network error');
          });
      };

      fetch('/api/health').then(function(r) { return r.json(); }).then(updateHoloHealth).catch(function() {
        if (healthCardEl) healthCardEl.style.display = '';
        setHealthText('<span class="dot red"></span>Unable to read /api/health right now.');
      });
      refreshHoloDiag(false);
      setInterval(function() { refreshHoloDiag(false); }, 30000);

      window.onHealthUpdate = updateHoloHealth;
    })();
  </script>
</body>
</html>
