<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panels â€” AstroPixels</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/icons8-r2-d2-color-32.png?v=2">
  <link rel="shortcut icon" type="image/png" href="/icons8-r2-d2-color-32.png?v=2">
  <link rel="apple-touch-icon" sizes="192x192" href="/icons8-r2-d2-color-192.png">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <h1>Dome Panels ðŸ§©</h1>
  <div class="subtitle">Servo-actuated dome panel control</div>
  <nav>
    <a href="/">Home</a>
    <a href="/setup.html">Setup</a>
    <a href="/panels.html" class="active">Panels</a>
    <a href="/holos.html">Holos</a>
    <a href="/logics.html">Logics</a>
    <a href="/sequences.html">Sequences</a>
  </nav>

  <div class="card" id="panel-health-card">
    <h3>Panel Servo Controller Status</h3>
    <div id="panel-health-text" class="desc"><span class="dot yellow"></span>Checking controller health...</div>
    <div id="panel-i2c-list" class="desc mt-4">Detected I2C devices: ...</div>
    <div id="panel-i2c-codes" class="desc mt-4">I2C code: ...</div>
    <div id="panel-i2c-hint" class="desc mt-4">Troubleshooting hint: ...</div>
    <div class="mt-8"><button id="panel-deep-btn" class="btn" onclick="window.runPanelDeepDiag()">Run Deep I2C Scan</button></div>
    <div id="panel-deep-result" class="desc mt-4">Deep scan result: not run yet. Full-bus scan checks addresses 0x01-0x7E.</div>
  </div>

  <!-- All Panels -->
  <div class="card">
    <h3>All Panels</h3>
    <div class="btn-grid">
      <button class="btn accent" onclick="sendCmd(':OP00')">Open All</button>
      <button class="btn" onclick="sendCmd(':CL00')">Close All</button>
      <button class="btn" onclick="sendCmd(':OF00')">Flutter All</button>
    </div>
  </div>

  <!-- Panel Animations -->
  <div class="card">
    <h3>Animations (All Panels)</h3>
    <div class="desc">Dynamic animations applied to all dome panels</div>
    <div class="btn-grid mt-8">
      <button class="btn" onclick="sendCmd(':SE52')">Wave</button>
      <button class="btn" onclick="sendCmd(':SE53')">Fast Wave</button>
      <button class="btn" onclick="sendCmd(':SE54')">Open/Close Wave</button>
      <button class="btn" onclick="sendCmd(':SE55')">Marching Ants</button>
      <button class="btn" onclick="sendCmd(':SE56')">Faint</button>
      <button class="btn" onclick="sendCmd(':SE57')">Rhythmic</button>
      <button class="btn" onclick="sendCmd(':SE51')">Scream (panels)</button>
    </div>
  </div>

  <div class="card">
    <h3>Pie Panel Movement</h3>
    <div class="desc">Upper pie panels (Pie Panel X / PPX).</div>
    <div class="table-wrap">
    <table class="panel-table">
      <tr class="panel-head">
        <td class="panel-cell">Panel</td>
        <td class="panel-cell-center">Open</td>
        <td class="panel-cell-center">Close</td>
        <td class="panel-cell-center">Flutter</td>
      </tr>
      <tr><td class="panel-cell">Pie Panel 1 (PP1)</td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OP05')">Open</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':CL05')">Close</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OF05')">Flutter</button></td></tr>
      <tr><td class="panel-cell">Pie Panel 2 (PP2)</td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OP06')">Open</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':CL06')">Close</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OF06')">Flutter</button></td></tr>
      <tr><td class="panel-cell">Pie Panel 3 (PP3)</td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OP08')">Open</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':CL08')">Close</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OF08')">Flutter</button></td></tr>
      <tr><td class="panel-cell">Pie Panel 4 (PP4)</td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OP09')">Open</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':CL09')">Close</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OF09')">Flutter</button></td></tr>
      <tr><td class="panel-cell">Pie Panel 5 (PP5)</td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OP11')">Open</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':CL11')">Close</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OF11')">Flutter</button></td></tr>
      <tr><td class="panel-cell">Pie Panel 6 (PP6)</td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OP12')">Open</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':CL12')">Close</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OF12')">Flutter</button></td></tr>
    </table>
    </div>
  </div>

  <div class="card">
    <h3>Lower Panel Movement</h3>
    <div class="desc">Lower dome panels (Panel X / PX).</div>
    <div class="desc mt-4">Each row shows the panel name first, then the legacy command number used in this UI.</div>
    <div class="table-wrap">
    <table class="panel-table">
      <tr class="panel-head">
        <td class="panel-cell">Panel</td>
        <td class="panel-cell-center">Open</td>
        <td class="panel-cell-center">Close</td>
        <td class="panel-cell-center">Flutter</td>
      </tr>
      <tr><td class="panel-cell">Panel 1 (P1)</td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OP01')">Open</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':CL01')">Close</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OF01')">Flutter</button></td></tr>
      <tr><td class="panel-cell">Panel 2 (P2)</td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OP02')">Open</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':CL02')">Close</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OF02')">Flutter</button></td></tr>
      <tr><td class="panel-cell">Panel 3 (P3)</td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OP03')">Open</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':CL03')">Close</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OF03')">Flutter</button></td></tr>
      <tr><td class="panel-cell">Panel 4 (P4)</td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OP04')">Open</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':CL04')">Close</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OF04')">Flutter</button></td></tr>
      <tr><td class="panel-cell">Panel 7 (P7)</td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OP07')">Open</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':CL07')">Close</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OF07')">Flutter</button></td></tr>
      <tr><td class="panel-cell">Panel 10 (P10)</td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OP10')">Open</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':CL10')">Close</button></td>
        <td class="panel-cell-center"><button class="btn" onclick="sendCmd(':OF10')">Flutter</button></td></tr>
    </table>
    </div>
  </div>

  <div class="card">
    <h3>Panel Servo Calibration</h3>
    <div class="desc">Select a panel, test position with temporary move, then store open/closed values.</div>
    <div class="desc mt-4">Extended compatibility targets are supported for builds that expose top/bottom aliases.</div>

    <div class="row mt-8">
      <label class="label-dim" for="cal-panel">Panel:</label>
      <select id="cal-panel" class="flex-1" onchange="updateCalPreview()">
        <optgroup label="Lower Dome Panels">
          <option value="01">Panel 1 (P1)</option>
          <option value="02">Panel 2 (P2)</option>
          <option value="03">Panel 3 (P3)</option>
          <option value="04">Panel 4 (P4)</option>
          <option value="07">Panel 7 (P7)</option>
          <option value="10">Panel 10 (P10)</option>
        </optgroup>
        <optgroup label="Upper Pie Panels">
          <option value="05">Pie Panel 1 (PP1)</option>
          <option value="06">Pie Panel 2 (PP2)</option>
          <option value="08">Pie Panel 3 (PP3)</option>
          <option value="09">Pie Panel 4 (PP4)</option>
          <option value="11">Pie Panel 5 (PP5)</option>
          <option value="12">Pie Panel 6 (PP6)</option>
        </optgroup>
        <optgroup label="Extended Compatibility Targets">
          <option value="13">Top Center Panel (target 13)</option>
          <option value="14">Top Panels Alias (target 14)</option>
          <option value="15">Bottom Panels Alias (target 15)</option>
        </optgroup>
      </select>
    </div>

    <div class="row mt-8">
      <label class="label-dim" for="cal-pos">Position:</label>
      <input id="cal-pos" type="number" min="700" max="2300" step="1" value="1500" class="flex-1" oninput="updateCalPreview()">
      <button class="btn" onclick="sendMovePosition()">Move (:MV)</button>
    </div>

    <div class="btn-grid mt-8">
      <button class="btn accent" onclick="saveOpenPosition()">Save Open (#SO)</button>
      <button class="btn" onclick="saveClosedPosition()">Save Closed (#SC)</button>
      <button class="btn danger" onclick="swapOpenClosed()">Swap Open/Closed (#SW)</button>
    </div>

    <div class="label-dim mt-8">Command preview:</div>
    <div id="cal-preview" class="desc mt-4">:MV011500</div>

    <div class="label-dim mt-10">Best Practice Panel Adjustment</div>
    <div class="desc mt-4">3) Use <code>:MVxxdddd</code> to explore servo range.</div>
    <div class="desc">4) When you find a good open position, store with <code>#SOxxdddd</code>.</div>
    <div class="desc">5) When you find a good closed position, store with <code>#SCxxdddd</code>.</div>
    <div class="desc">Example: <code>:MV010900</code> -> <code>#SO010900</code> (open), <code>:MV011750</code> -> <code>#SC011750</code> (closed).</div>
    <div class="desc">6) <code>:MVxxdddd</code> does not store; it only moves the servo temporarily.</div>
    <div class="desc mt-6">Quick swap shortcut: <code>#SWxx</code> swaps open/closed and stores immediately. Use only during calibration, never at every boot.</div>
  </div>

  <div class="status-bar" id="conn-status"><span class="dot yellow"></span>Connecting...</div>
  <script src="/app.js"></script>
  <script>
    (function() {
      var healthTextEl = document.getElementById('panel-health-text');
      var i2cListEl = document.getElementById('panel-i2c-list');
      var i2cCodesEl = document.getElementById('panel-i2c-codes');
      var i2cHintEl = document.getElementById('panel-i2c-hint');
      var deepResultEl = document.getElementById('panel-deep-result');
      var deepBtnEl = document.getElementById('panel-deep-btn');
      var healthCardEl = document.getElementById('panel-health-card');

      function setHealthText(html) {
        if (healthTextEl) healthTextEl.innerHTML = html;
      }

      function updatePanelHealth(h) {
        if (!h || typeof h.i2c_panels === 'undefined') return;

        if (h.i2c_panels) {
          if (healthCardEl) healthCardEl.style.borderLeftColor = 'var(--success)';
          setHealthText('<span class="dot green"></span>Panel servo controller detected at I2C 0x40. Panel movement commands should reach hardware.');
        } else {
          if (healthCardEl) healthCardEl.style.borderLeftColor = 'var(--warning)';
          setHealthText('<span class="dot yellow"></span>No panel servo controller detected at I2C 0x40. Check panel controller power/wiring.');
        }

        if (i2cListEl) {
          if (h.i2c_devices && h.i2c_devices.length > 0) {
            i2cListEl.textContent = 'Detected I2C devices: ' + h.i2c_devices.join(', ');
          } else {
            i2cListEl.textContent = 'Detected I2C devices: none';
          }
        }
      }

      function updatePanelDiag(d) {
        if (!d || !d.panels) return;
        if (i2cCodesEl) {
          i2cCodesEl.textContent =
            'I2C code/streak for panel controller (0x40): code ' + d.panels.last_code +
            ', failures ' + d.panels.consecutive_failures +
            ' | scan age ' + d.scan_age_ms + ' ms';
        }

        if (i2cHintEl) {
          var hint = '';
          if (d.operator && d.operator.hints && d.operator.hints.length > 0) {
            hint = d.operator.hints[0];
          }
          i2cHintEl.textContent = hint
            ? ('Troubleshooting hint: ' + hint)
            : 'Troubleshooting hint: I2C checks are currently stable.';
        }
      }

      function setDeepStateRunning() {
        if (deepBtnEl) {
          deepBtnEl.disabled = true;
          deepBtnEl.textContent = 'Running Deep I2C Scan...';
        }
        if (deepResultEl) {
          deepResultEl.textContent = 'Deep scan result: running full-bus scan (0x01-0x7E)...';
        }
      }

      function setDeepStateIdle() {
        if (deepBtnEl) {
          deepBtnEl.disabled = false;
          deepBtnEl.textContent = 'Run Deep I2C Scan';
        }
      }

      function updateDeepResult(d) {
        if (!deepResultEl || !d) return;
        var faults = (d.operator && d.operator.faults && d.operator.faults.length) ? d.operator.faults.join(', ') : 'none';
        var devices = (d.devices && d.devices.length) ? d.devices.join(', ') : 'none';
        var status = (d.panels && d.panels.ok) ? 'panel controller detected' : 'panel controller missing';
        var ts = new Date().toLocaleTimeString();
        deepResultEl.textContent =
          '[' + ts + '] Deep scan done (full bus 0x01-0x7E): ' + status +
          '; devices=' + d.device_count +
          ' [' + devices + ']' +
          '; duration=' + d.scan_duration_us + ' us' +
          '; faults=' + faults +
          '; scan_mode=' + d.scan_mode + '.';
      }

      function refreshPanelDiag(force) {
        var url = force ? '/api/diag/i2c?force=1' : '/api/diag/i2c';
        if (force) setDeepStateRunning();
        return fetch(url).then(function(r) { return r.json(); }).then(function(d) {
          updatePanelDiag(d);
          if (force) {
            updateDeepResult(d);
            if (typeof window.uiToast === 'function') window.uiToast('Deep I2C scan completed', d.panels && d.panels.ok ? '' : 'warn');
          }
          return d;
        }).catch(function() {
          if (i2cCodesEl) i2cCodesEl.textContent = 'I2C code: unable to read /api/diag/i2c';
          if (i2cHintEl) i2cHintEl.textContent = 'Troubleshooting hint: diagnostics endpoint unavailable right now.';
          if (force && deepResultEl) deepResultEl.textContent = 'Deep scan result: failed (cannot reach /api/diag/i2c).';
          if (force && typeof window.uiToast === 'function') window.uiToast('Deep I2C scan failed', 'error');
        }).finally(function() {
          if (force) setDeepStateIdle();
        });
      }

      window.runPanelDeepDiag = function() {
        refreshPanelDiag(true);
      };

      fetch('/api/health').then(function(r) { return r.json(); }).then(updatePanelHealth).catch(function() {
        setHealthText('<span class="dot red"></span>Unable to read /api/health right now.');
      });
      refreshPanelDiag(false);
      setInterval(function() { refreshPanelDiag(false); }, 30000);

      window.onHealthUpdate = updatePanelHealth;
    })();

    function twoDigitPanel(v) {
      var n = String(v || '').replace(/\D/g, '');
      if (!n) n = '1';
      if (n.length === 1) n = '0' + n;
      return n.slice(0, 2);
    }

    function fourDigitPos(v) {
      var n = parseInt(v, 10);
      if (!isFinite(n)) n = 1500;
      if (n < 700) n = 700;
      if (n > 2300) n = 2300;
      var s = String(n);
      while (s.length < 4) s = '0' + s;
      return s;
    }

    function selectedPanel() {
      return twoDigitPanel(document.getElementById('cal-panel').value);
    }

    function selectedPos() {
      return fourDigitPos(document.getElementById('cal-pos').value);
    }

    function updateCalPreview() {
      var cmd = ':MV' + selectedPanel() + selectedPos();
      document.getElementById('cal-preview').textContent = cmd;
    }

    function sendMovePosition() {
      var cmd = ':MV' + selectedPanel() + selectedPos();
      sendCmd(cmd);
      updateCalPreview();
    }

    function saveOpenPosition() {
      var cmd = '#SO' + selectedPanel() + selectedPos();
      sendCmd(cmd);
      document.getElementById('cal-preview').textContent = cmd;
    }

    function saveClosedPosition() {
      var cmd = '#SC' + selectedPanel() + selectedPos();
      sendCmd(cmd);
      document.getElementById('cal-preview').textContent = cmd;
    }

    function swapOpenClosed() {
      var cmd = '#SW' + selectedPanel();
      sendCmd(cmd);
      document.getElementById('cal-preview').textContent = cmd;
    }

    updateCalPreview();
  </script>
</body>
</html>
