<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AstroPixels</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .health-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; }
    .health-item {
      display:flex; align-items:center; gap:8px;
      padding:8px 10px; background:var(--bg); border-radius:6px;
      font-size:0.85em;
    }
    .health-item .indicator {
      width:12px; height:12px; border-radius:50%;
      background:#555; flex-shrink:0;
      transition: background 0.3s, box-shadow 0.3s;
    }
    .health-item .indicator.ok { background:var(--success); box-shadow:0 0 6px var(--success); }
    .health-item .indicator.fail { background:var(--danger); box-shadow:0 0 6px var(--danger); }
    .health-item .indicator.warn { background:var(--warning); box-shadow:0 0 6px var(--warning); }
    .i2c-list { font-size:0.8em; color:var(--text-dim); margin-top:6px; }
  </style>
</head>
<body>
  <h1>AstroPixels</h1>
  <div class="subtitle">R2-D2 Dome Controller</div>
  <nav>
    <a href="/" class="active" title="Main dashboard: health, logs, and quick actions">Home</a>
    <a href="/panels.html" title="Open, close, and animate dome panels">Panels</a>
    <a href="/holos.html" title="Control holo projector lights and servo movement">Holos</a>
    <a href="/logics.html" title="Control front/rear logic displays and PSI effects">Logics</a>
    <a href="/sequences.html" title="Run combined panel, holo, and logic choreography">Sequences</a>
    <a href="/setup.html" title="WiFi, serial, sound, remote, and firmware settings">Setup</a>
  </nav>

  <!-- Quick Actions -->
  <div class="card">
    <h3>Quick Actions</h3>
    <div class="btn-grid">
      <button class="btn accent" onclick="sendCmd(':SE01')" title="Run sequence 01: scream-style attention mode">Scream</button>
      <button class="btn" onclick="sendCmd(':SE07')" title="Run sequence 07: cantina-style movement pattern">Cantina</button>
      <button class="btn" onclick="sendCmd(':SE09')" title="Run sequence 09: disco-style animation pattern">Disco</button>
      <button class="btn" onclick="sendCmd(':SE08')" title="Run sequence 08: Leia-style animation pattern">Leia</button>
      <button class="btn danger" onclick="sendCmd(':SE00')" title="Stop active panel sequence and return to idle">Stop</button>
    </div>
  </div>

  <!-- Health Dashboard -->
  <div class="card">
    <h3>Subsystem Health</h3>
    <div class="health-grid" id="health-grid">
      <div class="health-item" title="Panel servo controller at I2C address 0x40 (dome panel movement)"><div class="indicator" id="h-panels"></div><span>Servo Panels</span></div>
      <div class="health-item" title="Holo servo controller at I2C address 0x41 (holo pitch/yaw movement)"><div class="indicator" id="h-holos"></div><span>Servo Holos</span></div>
      <div class="health-item" title="Sound output availability based on sound module preference state"><div class="indicator" id="h-sound"></div><span>Sound Module</span></div>
      <div class="health-item" title="Current WiFi service state on this controller"><div class="indicator" id="h-wifi"></div><span>WiFi</span></div>
      <div class="health-item" title="Droid remote link state (warn means remote feature disabled)"><div class="indicator" id="h-remote"></div><span>Droid Remote</span></div>
      <div class="health-item" title="SPI flash file system mount state used by web UI files"><div class="indicator" id="h-spiffs"></div><span>SPIFFS</span></div>
    </div>
    <div class="i2c-list" id="i2c-list" title="Detected I2C addresses responding on the bus"></div>
  </div>

  <!-- Live Log Console -->
  <div class="card">
    <h3 title="Live firmware log stream. Scroll up to pause auto-follow.">Live Log Console</h3>
    <div id="log-wrap" style="position:relative;">
      <pre id="log-console" title="Recent runtime logs from the controller" style="
        background:var(--bg); color:var(--silver); border:1px solid var(--border);
        border-radius:4px; padding:8px; font-size:0.75em; line-height:1.4;
        height:180px; overflow-y:auto; white-space:pre-wrap; word-break:break-all;
      "></pre>
      <div id="log-paused" title="Auto-scroll paused while viewing older lines" style="
        display:none; position:absolute; top:4px; right:12px;
        background:var(--warning); color:var(--bg); padding:2px 8px;
        border-radius:3px; font-size:0.7em; font-weight:600;
      ">PAUSED</div>
    </div>
  </div>

  <div class="card">
    <h3>Manual Command</h3>
    <div class="desc">Send any Marcduino command directly (example: :OP01, *ON00, @0T5)</div>
    <div style="display:flex; gap:6px; margin-top:8px; align-items:center;">
      <input
        type="text"
        id="manual-cmd"
        placeholder="Enter command..."
        title="Type a raw Marcduino command and press Enter or Send"
        style="flex:1;"
        onkeydown="if(event.key==='Enter'){var c=this.value.trim(); if(c){sendCmd(c); this.value='';}}"
      >
      <button
        class="btn accent"
        title="Send manual command"
        onclick="var i=document.getElementById('manual-cmd'); var c=i.value.trim(); if(c){sendCmd(c); i.value='';}"
      >Send</button>
    </div>
  </div>

  <!-- System Status -->
  <div class="card">
    <h3 title="Live state snapshot: uptime, memory, connectivity, OTA status">System</h3>
    <div id="sys-status" title="Updates automatically from WebSocket state broadcasts" style="font-size:0.85em; color:var(--text-dim);">Loading...</div>
  </div>

  <!-- OTA Progress Overlay -->
  <div class="ota-overlay" id="ota-overlay">
    <div>Firmware Update in Progress...</div>
    <div class="ota-bar"><div class="ota-bar-fill" id="ota-bar-fill"></div></div>
    <div id="ota-percent">0%</div>
  </div>

  <div class="status-bar" id="conn-status" title="Browser WebSocket link to controller"><span class="dot yellow"></span>Connecting...</div>

  <script src="/app.js"></script>
  <script>
    function setIndicator(id, ok) {
      var el = document.getElementById(id);
      if (el) { el.className = 'indicator ' + (ok ? 'ok' : 'fail'); }
    }
    function setIndicatorWarn(id, ok, enabled) {
      var el = document.getElementById(id);
      if (el) {
        if (!enabled) el.className = 'indicator warn';
        else el.className = 'indicator ' + (ok ? 'ok' : 'fail');
      }
    }
    function updateHealth(h) {
      setIndicator('h-panels', h.i2c_panels);
      setIndicator('h-holos', h.i2c_holos);
      setIndicator('h-sound', h.sound_module);
      setIndicator('h-wifi', h.wifi);
      setIndicatorWarn('h-remote', h.remote, h.remote_enabled);
      setIndicator('h-spiffs', h.spiffs);

      if (h.i2c_devices && h.i2c_devices.length > 0) {
        document.getElementById('i2c-list').textContent = 'I2C devices: ' + h.i2c_devices.join(', ');
      }
    }

    function updateStatus(s) {
      var html = '';
      html += '<div>Uptime: ' + Math.floor(s.uptime/60) + 'm ' + (s.uptime%60) + 's</div>';
      html += '<div>Free Heap: ' + (s.freeHeap/1024).toFixed(1) + ' KB</div>';
      html += '<div>WiFi: ' + (s.wifiEnabled ? '<span class="dot green"></span>Enabled' : '<span class="dot red"></span>Disabled');
      if (s.wifiIP) html += ' (' + s.wifiIP + ')';
      if (s.wifiRSSI && !s.wifiAP) html += ' ' + s.wifiRSSI + ' dBm';
      html += '</div>';
      if (typeof s.remoteConnected !== 'undefined') {
        html += '<div>Droid Remote: ' + (s.remoteConnected ? '<span class="dot green"></span>Connected' : '<span class="dot red"></span>Disconnected') + '</div>';
      }
      if (s.otaInProgress) {
        html += '<div><span class="dot yellow"></span>Firmware update in progress</div>';
      }
      document.getElementById('sys-status').innerHTML = html;
    }

    // --- Log Console ---
    var logEl = document.getElementById('log-console');
    var logPaused = document.getElementById('log-paused');
    var logAutoScroll = true;
    var LOG_MAX_LINES = 200;

    // Detect user scroll â€” pause auto-scroll when scrolled up
    logEl.addEventListener('scroll', function() {
      var atBottom = (logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight) < 20;
      logAutoScroll = atBottom;
      logPaused.style.display = atBottom ? 'none' : 'block';
    });

    function appendLogLine(text) {
      logEl.textContent += text + '\n';
      // Trim old lines if too many
      var lines = logEl.textContent.split('\n');
      if (lines.length > LOG_MAX_LINES + 50) {
        logEl.textContent = lines.slice(lines.length - LOG_MAX_LINES).join('\n');
      }
      if (logAutoScroll) {
        logEl.scrollTop = logEl.scrollHeight;
      }
    }

    // WebSocket log handler
    window.onLogLine = appendLogLine;

    // Fetch initial log buffer
    fetch('/api/logs').then(function(r){return r.json();}).then(function(data){
      if (data.lines) {
        data.lines.forEach(function(line) { appendLogLine(line); });
      }
    }).catch(function(){});

    // Initial fetch
    fetchState(updateStatus);
    fetch('/api/health').then(function(r){return r.json();}).then(updateHealth).catch(function(){});

    // OTA progress handler
    window.onOtaProgress = function(progress) {
      var overlay = document.getElementById('ota-overlay');
      var fill = document.getElementById('ota-bar-fill');
      var pct = document.getElementById('ota-percent');
      overlay.classList.add('active');
      var p = Math.round(progress * 100);
      fill.style.width = p + '%';
      pct.textContent = p + '%';
      if (p >= 100) {
        pct.textContent = 'Rebooting...';
      }
    };

    // WebSocket live updates
    window.onStateUpdate = updateStatus;
    window.onHealthUpdate = updateHealth;
  </script>
</body>
</html>
